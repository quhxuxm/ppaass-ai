name: Ppaass Security Proxy

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    # 核心配置：指定使用 Debian 镜像
    container:
      image: debian:bookworm-slim # 你可以选择 bullseye 或 bookworm 等版本

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 Debian 依赖与 Rust
        run: |
          apt-get update && apt-get install -y \
            curl build-essential gcc pkg-config libssl-dev
          # 在容器内手动安装 rustup
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          # 将 cargo 路径加入当前 shell
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: 编译项目
        run: |
          cargo build --release

      - name: 运行测试
        run: |
          cargo test --verbose

      - name: 传输文件到服务器 (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          source: "target/release/proxy,config/remote/proxy.toml,config/remote/users.toml,start-proxy.sh" # 替换为你的二进制文件名
          target: "/ppaass-ai" # 服务器目标路径
          strip_components: 2
      - name: 远程执行启动脚本 (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            chmod +x /ppaass-ai/start-proxy.sh
            chmod +x /ppaass-ai/proxy
            # Stop existing proxy process
            process_id=$(ps -ef | grep "./proxy" | grep -v grep | awk '{print $2}')
            if [ -n "$process_id" ]; then
              kill -9 $process_id || true
            fi
            # Start the proxy (migration is handled in start-proxy.sh)
            cd /ppaass-ai
            ulimit -n 655360
            nohup ./start-proxy.sh >run.log 2>&1 &
      - name: 部署完成
        run: |
          echo "部署成功！"
